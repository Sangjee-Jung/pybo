{% extends 'base.html' %}
{% block content %}

{% load static %}
<link rel="stylesheet" href="{% static 'style.css' %}">

<div class="container my-3">
    <h2 class="border-bottom py-2">
        <b>외감대상 실험</b>
    </h2>


    <div class="container-fluid">
        <div class="row">
            <div class="accordion col-sm-4" id="lv1Accordion" >
                <!-- 1st 아코디언(Lv1)  -->
                {% for lv1_item in industry_tree %}
                <div class="accordion-item">
                    <h2 class="accordion-header m-2" id="lv1Heading{{ forloop.counter }}">
                        <span style="font-size: 15px;">
                            {{ lv1_item.lv1_header }}
                        </span>
                        <button class="btn btn-outline-dark btn-sm toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#lv1Collapse{{ forloop.counter }}">+</button>
                    </h2>
                    <div id="lv1Collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="lv1Heading{{ forloop.counter }}" data-bs-parent="#lv1Accordion">
                        <div class="accordion-body">

                            <!-- 2nd 아코디언(Lv2)  -->
                            <div class="accordion" id="lv2Accordion{{ forloop.counter }}">
                                {% for lv2_item in lv1_item.lv1_contents %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header m-2" id="lv2Heading{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                                        <span
                                                style="font-size: 15px; cursor: pointer;"
                                                onmouseover="this.style.color='blue'; this.style.fontWeight='bold';"
                                                onmouseout="this.style.color=''; this.style.fontWeight='normal';"
                                                onclick="accordionClicked(event)"
                                                data-code="{{ lv2_item.lv2_header.2 }}"
                                        >
                                            {{ lv2_item.lv2_header.0 }}
                                        </span>
                                        <button class="btn btn-dark btn-sm toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#lv2Collapse{{ forloop.parentloop.counter }}-{{ forloop.counter }}">+</button>
                                        <span style="font-size: 15px; color: silver;"><i> -- 총 {{ lv2_item.lv2_header.1 }}개사 </i></span>
                                    </h2>
                                    <div id="lv2Collapse{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="lv2Heading{{ forloop.parentloop.counter }}-{{ forloop.counter }}" data-bs-parent="#lv2Accordion{{ forloop.parentloop.counter }}">
                                        <div class="accordion-body">

                                            <!-- 3rd 아코디언(Lv3) -->
                                            <div class="accordion" id="lv3Accordion{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                                                {% for lv3_item in lv2_item.lv2_contents %}
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header m-2" id="lv3Heading{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                                                        <span
                                                                style="font-size: 15px; cursor: pointer;"
                                                                onmouseover="this.style.color='blue'; this.style.fontWeight='bold';"
                                                                onmouseout="this.style.color=''; this.style.fontWeight='normal';"
                                                                onclick="accordionClicked(event)"
                                                                data-code="{{ lv3_item.lv3_header.2 }}"
                                                        >
                                                            {{ lv3_item.lv3_header.0 }}
                                                        </span>
                                                        <button class="btn btn-secondary btn-sm toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#lv3Collapse{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">+</button>
                                                        <span style="font-size: 15px; color: silver;"><i> -- {{ lv3_item.lv3_header.1 }}개사 </i></span>
                                                    </h2>
                                                    <div id="lv3Collapse{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="lv3Heading{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" data-bs-parent="#lv3Accordion{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}">
                                                        <div class="accordion-body">

                                                            <!-- 4th 아코디언(Lv4) -->
                                                            <div class="accordion" id="lv4Accordion{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                                                                {% for lv4_item in lv3_item.lv3_contents %}
                                                                <div class="accordion-item">
                                                                    <h2 class="accordion-header m-2" id="lv4Heading{{ forloop.parentloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">
                                                                        <span
                                                                                style="font-size: 15px; cursor: pointer;"
                                                                                onmouseover="this.style.color='blue'; this.style.fontWeight='bold';"
                                                                                onmouseout="this.style.color=''; this.style.fontWeight='normal';"
                                                                                onclick="accordionClicked(event)"
                                                                                data-code="{{ lv4_item.lv4_header.2 }}"
                                                                        >
                                                                            {{ lv4_item.lv4_header.0 }}
                                                                        </span>
                                                                        <button class="btn btn-info btn-sm toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#lv4Collapse{{ forloop.parentloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}">+</button>
                                                                        <span style="font-size: 15px; color: silver;"><i> -- {{ lv4_item.lv4_header.1 }}개사 </i></span>
                                                                    </h2>
                                                                    <div id="lv4Collapse{{ forloop.parentloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="lv4Heading{{ forloop.parentloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" data-bs-parent="#lv4Accordion{{ forloop.parentloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}">
                                                                        <div class="accordion-body">
                                                                            {% for content in lv4_item.lv4_contents.0 %}
                                                                            <li style="cursor: pointer;" onmouseover="this.style.color='blue'; this.style.fontWeight='bold';" onmouseout="this.style.color=''; this.style.fontWeight='normal';" onclick="accordionClicked(event, '{{ content }}')">
                                                                                {{ content }}
                                                                            </li>
                                                                            {% endfor %}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {% endfor %}
                                                            </div>
                                                            <!-- 4th 아코디언 끝 -->

                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <!-- 3rd 아코디언 끝 -->

                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="col-sm-8">
                <div class="col-auto">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type = "checkbox" name = "category" id = "category_상장" value = "상장" checked
                               onclick="accordionClicked(event)"
                        >
                        <label class="form-check-label" for="category_상장">상장</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type = "checkbox" name = "category" id = "category_코스닥" value = "코스닥" checked
                               onclick="accordionClicked(event)"
                        >
                        <label class="form-check-label" for="category_코스닥">코스닥</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type = "checkbox" name = "category" id = "category_코넥스" value = "코넥스" checked
                               onclick="accordionClicked(event)"
                        >
                        <label class="form-check-label" for="category_코넥스">코넥스</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type = "checkbox" name = "category" id = "category_외감" value = "외감" checked
                               onclick="accordionClicked(event)"
                        >
                        <label class="form-check-label" for="category_외감">외감</label>
                    </div>
                </div>
                <p></p>


                <div class="col-auto" id="output">
                    {{df | safe}}
                </div>

            </div>
        </div>
    </div>

    <script>

        const accordions = document.querySelectorAll('.accordion-collapse');

        accordions.forEach(accordion => {
            accordion.addEventListener('show.bs.collapse', function() {
                const button = document.querySelector(`[data-bs-target="#${accordion.id}"]`);
                button.textContent = '-';
            });

            accordion.addEventListener('hide.bs.collapse', function() {
                const button = document.querySelector(`[data-bs-target="#${accordion.id}"]`);
                button.textContent = '+';
            });
        });

    </script>

    <script>
        let currentCode = null;  // 최근 클릭된 아코디언 항목의 data-code 값을 저장하기 위한 전역 변수

        function accordionClicked(event) {
            const clickedElement = event.target;

            if(clickedElement.tagName !== 'INPUT') {
                currentCode = clickedElement.getAttribute('data-code');
            }

            var output = "";

            // 체크박스에서 체크된 값을 가져옴
            var checkedValues = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(input => input.value);

            // AJAX 요청 시작
            fetch(`/ajax/?code=${currentCode}`)
                .then(response => response.json())
                .then(data => {

                    var filteredData = data.df.filter(row => checkedValues.includes(row['Category']));  // 원하는_열_이름에 따라 데이터 필터링
                    output += `<p><i>Filtered Companies: ${filteredData.length}개사</i></p>`;

                    // 테이블의 총 row 수를 추가

                    // DataFrame을 HTML 테이블로 변환
                    var tableHTML = '<table border="1" class="table table-sm">';
                    var headers = Object.keys(filteredData[0]);

                    // 헤더 부분 추가
                    tableHTML += '<thead><tr>';
                    tableHTML += '<th>No.</th>';  // Row number를 위한 header 추가
                    headers.forEach(header => {
                        tableHTML += `<th>${header}</th>`;
                    });
                    tableHTML += '</tr></thead>';

                    // 본문 부분 추가
                    tableHTML += '<tbody>';
                    filteredData.forEach((row, index) => {
                        tableHTML += '<tr>';
                        tableHTML += `<td>${index + 1}</td>`;  // Row number 추가
                        headers.forEach(header => {
                            tableHTML += `<td>${row[header]}</td>`;
                        });
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody>';

                    tableHTML += '</table>';

                    // output 변수에 tableHTML을 추가
                    output += tableHTML;

                    document.getElementById('output').innerHTML = output;

                });

        }
    </script>


</div>
{% endblock %}